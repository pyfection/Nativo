services:
  db:
    image: postgres:16-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-nativo}_db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-nativo}
      POSTGRES_USER: ${POSTGRES_USER:-nativo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nativo}
    volumes:
    - postgres_data:/var/lib/postgresql/data
    ports:
    - 5434:5432
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-nativo}
      interval: 10s
      timeout: 5s
      retries: 5
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: ${COMPOSE_PROJECT_NAME:-nativo}_backend
    volumes:
    - ./backend:/app/backend
    - ./pyproject.toml:/app/pyproject.toml
    - backend-uploads:/app/backend/uploads
    - /app/.venv
    ports:
    - 8011:8000
    environment:
    - DEBUG=1
    - SECRET_KEY=${SECRET_KEY:-change-me-in-production-min-32-chars-long}
    - DATABASE_URL=postgresql://nativo:nativo@db:5432/nativo
    depends_on:
      db:
        condition: service_healthy
    entrypoint: "sh -c \"\n  echo 'Waiting for database to be ready...'\n  sleep 5\n  echo 'Running migrations...'\n  cd /app/backend\n  uv run alembic upgrade head || echo 'Migrations skipped or failed'\n  echo 'Seeding database...'\n  if [ ! -f seed_dev_postgres_db.py ]; then\n    echo 'ERROR: seed_dev_postgres_db.py not found in /app/backend'\n    echo 'Current directory: $(pwd)'\n    echo 'Files in /app/backend:'\n    ls -la /app/backend/ | head -20\n    exit 1\n  fi\n  uv run python seed_dev_postgres_db.py || echo 'Seed script failed (this is OK if database already has data)'\n  echo 'Starting server...'\n  exec uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload\n\"\n"
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    container_name: ${COMPOSE_PROJECT_NAME:-nativo}_frontend
    command: npm run dev -- --host
    volumes:
    - ./frontend:/app/frontend
    - /app/frontend/node_modules
    ports:
    - 3011:5173
    environment:
    - CHOKIDAR_USEPOLLING=true
    - VITE_BASE=/env/pyfection/nativo/feature/smiley-popup-top-right/frontend
    - VITE_API_URL=http://localhost/env/pyfection/nativo/feature/smiley-popup-top-right/backend
    - VITE_API_BASE_URL=http://localhost/env/pyfection/nativo/feature/smiley-popup-top-right/backend
    depends_on:
    - backend
volumes:
  postgres_data: null
  backend-uploads: null
